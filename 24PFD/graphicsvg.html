<html>
<head>
<title>24PFD</title>
</head>
<body>

<h1>This will be a pfd in the foreseeable future</h1>

<label>Callsign:</label>
<input id="callsignInput" type="text" placeholder="Apollo-3935">
<button onclick="setCallsign()">Visa</button>

<svg width="800" height="800"
     viewBox="-400 -400 800 800"
     style="border:1px solid black; background:gray">

  <g id="attitude">

    <!-- Himmel -->
    <rect x="-800" y="-800" width="1600" height="800" fill="skyblue"/>

    <!-- Mark -->
    <rect x="-800" y="0" width="1600" height="800" fill="sienna"/>

    <!-- Horisont -->
    <line x1="-800" y1="0" x2="800" y2="0"
          stroke="white" stroke-width="5"/>

    <!-- Pitch marks -->
    <g id="pitch_marks">
      <line x1="-170" y1="-50" x2="170" y2="-50" stroke="white"
      stroke-width="5"/>
      <line x1="-130" y1="-100" x2="130" y2="-100" stroke="white"
      stroke-width="5"/>
      <line x1="-200" y1="150" x2="200" y2="150" stroke="white"
      stroke-width="5"/>
      <line x1="-200" y1="-150" x2="200" y2="-150" stroke="white"
      stroke-width="5"/>
      <line x1="-170" y1="50" x2="170" y2="50" stroke="white"
      stroke-width="5"/>
      <line x1="-130" y1="100" x2="130" y2="100" stroke="white"
        stroke-width="5"/>
    </g>

  </g>
  <g id ="airplane_symbol">
    <line x1="-100" y1="0" x2="-10" y2="0" stroke="yellow"
      stroke-width="5"/>
    <line x1="0" y1="-5" x2="0" y2="5" stroke="yellow"
      stroke-width="5"/>
      <line x1="100" y1="0" x2="10" y2="0" stroke="yellow"
      stroke-width="5"/>
      </g>
</svg>

<script>

function setCallsign() {
  activeCallsign =
    document.getElementById("callsignInput").value.trim();

  //if (!data[activeCallsign]) {
  //console.log("No such aircraft yet");
  //return;
//}
  console.log("Tracking:", activeCallsign);
}

let activeCallsign = null;

 // function handleData(data) {
  //aircraftState.pitch = data.pitch;
  //aircraftState.roll  = data.roll;
  //aircraftState.heading = data.heading;
  //aircraftState.altitude = data.altitude;
//}

let aircraftState = {
  pitch: 0,
  roll: 0,
  heading: 0,
  altitude: 0
};

const ws = new WebSocket("ws://localhost:8765"); // WS url till backend
ws.onopen = () => {
    console.log("connected to backend");
};
ws.onmessage = (event) => {  // Tar hand om inkommande meddelanden
  const data = JSON.parse(event.data);

  if (!activeCallsign) return;
  if (!data[activeCallsign]) return;

  aircraftState.pitch = data[activeCallsign].pitch;
  aircraftState.roll  = data[activeCallsign].roll;

  //handleData(data);
  update();
};
ws.onclose = () => {   // Hanterar stÃ¤ngning av anslutning
    console.log("disconnected from backend");
};
ws.onerror = (err) => {  // loggar om det blir ett fel med WS
  console.error("WS error", err);
}

let PX_PER_DEG = 5

const attitude = document.getElementById("attitude");

function update() {
  const pitch_px = aircraftState.pitch * PX_PER_DEG;

  attitude.setAttribute(
    "transform",
    `translate(0, ${pitch_px}) rotate(${aircraftState.roll})`
  );
}

//setInterval(() => {   For testing without backend
    //aircraftState.pitch -= 0.3;
    //aircraftState.roll += 0.1;
    //aircraftState.pitch = Math.max(-30, Math.min(30, aircraftState.pitch));
    //aircraftState.roll = Math.max(-30, Math.min(30, aircraftState.roll));
    //update();
    
//}, 50);

</script>
</body>
</html>